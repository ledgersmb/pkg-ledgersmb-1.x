//>>built
define("dojo/data/ObjectStore",["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../promise/all","../_base/array","../_base/connect","../regexp"],function(e,a,t,r,d,i,l,o){function n(e){return"*"==e?".*":"?"==e?".":e}return t("dojo.data.ObjectStore",[a],{objectStore:null,constructor:function(a){this._dirtyObjects=[],a.labelAttribute&&(a.labelProperty=a.labelAttribute),e.mixin(this,a)},labelProperty:"label",getValue:function(e,a,t){return"function"==typeof e.get?e.get(a):a in e?e[a]:t},getValues:function(e,a){var t=this.getValue(e,a);return t instanceof Array?t:void 0===t?[]:[t]},getAttributes:function(e){var a=[];for(var t in e)!e.hasOwnProperty(t)||"_"==t.charAt(0)&&"_"==t.charAt(1)||a.push(t);return a},hasAttribute:function(e,a){return a in e},containsValue:function(e,a,t){return i.indexOf(this.getValues(e,a),t)>-1},isItem:function(e){return"object"==typeof e&&e&&!(e instanceof Date)},isItemLoaded:function(e){return e&&"function"!=typeof e.load},loadItem:function(e){var a;return"function"==typeof e.item.load?r.when(e.item.load(),function(t){a=t;var r=t instanceof Error?e.onError:e.onItem;r&&r.call(e.scope,t)}):e.onItem&&e.onItem.call(e.scope,e.item),a},close:function(e){return e&&e.abort&&e.abort()},fetch:function(a){function t(e){a.onError&&a.onError.call(l,e,a)}a=e.delegate(a,a&&a.queryOptions);var d=this,l=a.scope||d,m=a.query;if("object"==typeof m){m=e.delegate(m);for(var s in m){var f=m[s];"string"==typeof f&&(m[s]=RegExp("^"+o.escapeString(f,"*?\\").replace(/\\.|\*|\?/g,n)+"$",a.ignoreCase?"mi":"m"),m[s].toString=function(e){return function(){return e}}(f))}}var y=this.objectStore.query(m,a);return r.when(y.total,function(e){r.when(y,function(t){if(a.onBegin&&a.onBegin.call(l,e||t.length,a),a.onItem)for(var r=0;r<t.length;r++)a.onItem.call(l,t[r],a);return a.onComplete&&a.onComplete.call(l,a.onItem?null:t,a),t},t)},t),a.abort=function(){y.cancel&&y.cancel()},y.observe&&(this.observing&&this.observing.cancel(),this.observing=y.observe(function(e,a,t){if(-1==i.indexOf(d._dirtyObjects,e))if(-1==a)d.onNew(e);else if(-1==t)d.onDelete(e);else for(var r in e)r!=d.objectStore.idProperty&&d.onSet(e,r,null,e[r])},!0)),this.onFetch(y),a.store=this,a},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(e){return this.isItem(e)?this.getValue(e,this.labelProperty):void 0},getLabelAttributes:function(){return[this.labelProperty]},getIdentity:function(e){return this.objectStore.getIdentity?this.objectStore.getIdentity(e):e[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var a;return r.when(this.objectStore.get(e.identity),function(t){a=t,e.onItem.call(e.scope,t)},function(a){e.onError.call(e.scope,a)}),a},newItem:function(e,a){if(a){var t=this.getValue(a.parent,a.attribute,[]);t=t.concat([e]),e.__parent=t,this.setValue(a.parent,a.attribute,t)}return this._dirtyObjects.push({object:e,save:!0}),this.onNew(e),e},deleteItem:function(e){this.changing(e,!0),this.onDelete(e)},setValue:function(e,a,t){var r=e[a];this.changing(e),e[a]=t,this.onSet(e,a,r,t)},setValues:function(a,t,r){if(!e.isArray(r))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(a,t,r)},unsetAttribute:function(e,a){this.changing(e);var t=e[a];delete e[a],this.onSet(e,a,t,void 0)},changing:function(e,a){e.__isDirty=!0;for(var t=0;t<this._dirtyObjects.length;t++){var r=this._dirtyObjects[t];if(e==r.object)return void(a&&(r.object=!1,this._saveNotNeeded||(r.save=!0)))}var d=e instanceof Array?[]:{};for(t in e)e.hasOwnProperty(t)&&(d[t]=e[t]);this._dirtyObjects.push({object:!a&&e,old:d,save:!this._saveNotNeeded})},save:function(e){e=e||{};{var a,t=[],r=[],i=this,o=this._dirtyObjects;o.length}try{l.connect(e,"onError",function(){if(e.revertOnError!==!1){var a=o;o=r,i.revert(),i._dirtyObjects=a}else i._dirtyObjects=o.concat(r)});var n;this.objectStore.transaction&&(n=this.objectStore.transaction());for(var m=0;m<o.length;m++){var s=o[m],f=s.object,y=s.old;delete f.__isDirty,f?(a=this.objectStore.put(f,{overwrite:!!y}),t.push(a)):"undefined"!=typeof y&&(a=this.objectStore.remove(this.getIdentity(y)),t.push(a)),r.push(s),o.splice(m--,1)}d(t).then(function(a){e.onComplete&&e.onComplete.call(e.scope,a)},function(a){e.onError&&e.onError.call(e.scope,a)}),n&&n.commit()}catch(M){e.onError.call(e.scope,value)}},revert:function(){for(var e=this._dirtyObjects,a=e.length;a>0;){a--;var t=e[a],r=t.object,d=t.old;if(r&&d){for(var i in d)d.hasOwnProperty(i)&&r[i]!==d[i]&&(this.onSet(r,i,r[i],d[i]),r[i]=d[i]);for(i in r)d.hasOwnProperty(i)||(this.onSet(r,i,r[i]),delete r[i])}else d?this.onNew(d):this.onDelete(r);delete(r||d).__isDirty,e.splice(a,1)}},isDirty:function(e){return e?e.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(){}})});//# sourceMappingURL=ObjectStore.js.map