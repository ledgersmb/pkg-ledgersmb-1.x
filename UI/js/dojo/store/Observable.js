//>>built
define("dojo/store/Observable",["../_base/kernel","../_base/lang","../when","../_base/array"],function(e,a,t,r){var i=function(e){function i(a,r){var i=e[a];i&&(e[a]=function(d){var l;if("put"===a&&(l=e.getIdentity(d)),m)return i.apply(this,arguments);m=!0;try{var o=i.apply(this,arguments);return t(o,function(e){r("object"==typeof e&&e||d,l)}),o}finally{m=!1}})}var d,l=[],o=0;e=a.delegate(e),e.notify=function(e,a){o++;for(var t=l.slice(),r=0,i=t.length;i>r;r++)t[r](e,a)};var n=e.query;e.query=function(i,m){m=m||{};var s=n.apply(this,arguments);if(s&&s.forEach){var f=a.mixin({},m);delete f.start,delete f.count;var y,u=e.queryEngine&&e.queryEngine(i,f),M=o,v=[];s.observe=function(a,i){1==v.push(a)&&l.push(y=function(a,l){t(s,function(t){var n,s,f,y=t.length!=m.count;if(++M!=o)throw new Error("Query is out of date, you must observe() the query prior to any data modifications");var h,c=-1,g=-1;if(l!==d){var p=[].concat(t);for(u&&!a&&(p=u(t)),n=0,s=t.length;s>n;n++){var b=t[n];if(e.getIdentity(b)==l){if(p.indexOf(b)<0)continue;h=b,c=n,(u||!a)&&t.splice(n,1);break}}}if(u){if(a&&(u.matches?u.matches(a):u([a]).length)){var F=c>-1?c:t.length;t.splice(F,0,a),g=r.indexOf(u(t),a),t.splice(F,1),m.start&&0==g||!y&&g==t.length?g=-1:t.splice(g,0,a)}}else a&&(l!==d?g=c:m.start||(g=e.defaultIndex||0,t.splice(g,0,a)));if((c>-1||g>-1)&&(i||!u||c!=g)){var w=v.slice();for(n=0;f=w[n];n++)f(a||h,c,g)}})});var n={};return n.remove=n.cancel=function(){var e=r.indexOf(v,a);e>-1&&(v.splice(e,1),v.length||l.splice(r.indexOf(l,y),1))},n}}return s};var m;return i("put",function(a,t){e.notify(a,t)}),i("add",function(a){e.notify(a)}),i("remove",function(a){e.notify(void 0,a)}),e};return a.setObject("dojo.store.Observable",i),i});//# sourceMappingURL=Observable.js.map