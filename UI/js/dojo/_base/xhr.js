//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,n,r,o,i,a,s,c,u,d,l,f,h,p,g){e._xhrObj=p._create;var m=e.config;e.objectToQuery=r.objectToQuery,e.queryToObject=r.queryToObject,e.fieldToObject=i.fieldToObject,e.formToObject=i.toObject,e.formToQuery=i.toQuery,e.formToJson=i.toJson,e._blockAsync=!1;var v=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return c.fromJson(e.responseText||null)},"json-comment-filtered":function(e){!s.useCommentedJson;var t=e.responseText,n=t.indexOf("/*"),r=t.lastIndexOf("*/");if(-1==n||-1==r)throw new Error("JSON was not comment filtered");return c.fromJson(t.substring(n+2,r))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var n=e.responseXML;if(n&&t("dom-qsa2.1")&&!n.querySelectorAll&&t("dom-parser")&&(n=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!n||!n.documentElement)){var r=function(e){return"MSXML"+e+".DOMDocument"},o=["Microsoft.XMLDOM",r(6),r(4),r(3),r(2)];d.some(o,function(t){try{var r=new ActiveXObject(t);r.async=!1,r.loadXML(e.responseText),n=r}catch(o){return!1}return!0})}return n},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?v["json-comment-filtered"](e):v.json(e)}};e._ioSetArgs=function(t,n,s,c){var d={args:t,url:t.url},l=null;if(t.form){var f=o.byId(t.form),h=f.getAttributeNode("action");d.url=d.url||(h?h.value:e.doc?e.doc.URL:null),l=i.toObject(f)}var p=[{}];l&&p.push(l),t.content&&p.push(t.content),t.preventCache&&p.push({"dojo.preventCache":(new Date).valueOf()}),d.query=r.objectToQuery(u.mixin.apply(null,p)),d.handleAs=t.handleAs||"text";var g=new a(function(e){e.canceled=!0,n&&n(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});g.addCallback(s);var v=t.load;v&&u.isFunction(v)&&g.addCallback(function(e){return v.call(t,e,d)});var y=t.error;y&&u.isFunction(y)&&g.addErrback(function(e){return y.call(t,e,d)});var b=t.handle;return b&&u.isFunction(b)&&g.addBoth(function(e){return b.call(t,e,d)}),g.addErrback(function(e){return c(e,g)}),m.ioPublish&&e.publish&&d.args.ioPublish!==!1&&(g.addCallbacks(function(t){return e.publish("/dojo/io/load",[g,t]),t},function(t){return e.publish("/dojo/io/error",[g,t]),t}),g.addBoth(function(t){return e.publish("/dojo/io/done",[g,t]),t})),g.ioArgs=d,g};var y=function(e){var t=v[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},b=function(e,t){return t.ioArgs.args.failOk||console.error(e),e},_=function(t){0>=w&&(w=0,m.ioPublish&&e.publish&&(!t||t&&t.ioArgs.args.ioPublish!==!1)&&e.publish("/dojo/io/stop"))},w=0;f.after(h,"_onAction",function(){w-=1}),f.after(h,"_onInFlight",_),e._ioCancelAll=h.cancelAll,e._ioNotifyStart=function(t){m.ioPublish&&e.publish&&t.ioArgs.args.ioPublish!==!1&&(w||e.publish("/dojo/io/start"),w+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,n,r){e.ioArgs.options=e.ioArgs.args;u.mixin(e,{response:e.ioArgs,isValid:function(){return t(e)},isReady:function(){return n(e)},handleResponse:function(){return r(e)}}),h(e),_(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,n,r){var o,i=e._ioSetArgs(n,function(){o&&o.cancel()},y,b),a=i.ioArgs;"postData"in n?a.query=n.postData:"putData"in n?a.query=n.putData:"rawBody"in n?a.query=n.rawBody:(arguments.length>2&&!r||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(a);var s={method:t,handleAs:"text",timeout:n.timeout,withCredentials:n.withCredentials,ioArgs:a};"undefined"!=typeof n.headers&&(s.headers=n.headers),"undefined"!=typeof n.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=n.contentType),"undefined"!=typeof a.query&&(s.data=a.query),"undefined"!=typeof n.sync&&(s.sync=n.sync),e._ioNotifyStart(i);try{o=p(a.url,s,!0)}catch(c){return i.cancel(),i}return i.ioArgs.xhr=o.response.xhr,o.then(function(){i.resolve(i)}).otherwise(function(e){a.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),i.reject(e)}),i},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return g.checkStatus(e.status)},e._getText=function(t){var n;return e.xhrGet({url:t,sync:!0,load:function(e){n=e}}),n},u.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:i.fieldToObject,formToObject:i.toObject,objectToQuery:r.objectToQuery,formToQuery:i.toQuery,formToJson:i.toJson,queryToObject:r.queryToObject,contentHandlers:v,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map