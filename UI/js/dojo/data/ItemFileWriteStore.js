//>>built
define("dojo/data/ItemFileWriteStore",["../_base/lang","../_base/declare","../_base/array","../_base/json","../_base/kernel","./ItemFileReadStore","../date/stamp"],function(e,a,t,r,d,i,l){return a("dojo.data.ItemFileWriteStore",i,{constructor:function(e){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return l.toISOString(e,{zulu:!0})}),e&&e.referenceIntegrity===!1&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(a,t){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof a&&"undefined"!=typeof a)throw new Error("newItem() was passed something other than an object");var r=null,d=this._getIdentifierAttribute();if(d===Number)r=this._arrayOfAllItems.length;else{if(r=a[d],"undefined"==typeof r)throw new Error("newItem() was not passed an identity for the new item");if(e.isArray(r))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert("undefined"==typeof this._itemsByIdentity[r]),this._assert("undefined"==typeof this._pending._newItems[r]),this._assert("undefined"==typeof this._pending._deletedItems[r]);var i={};i[this._storeRefPropName]=this,i[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[r]=i,i[d]=[r]),this._arrayOfAllItems.push(i);var l=null;if(t&&t.parent&&t.attribute){l={item:t.parent,attribute:t.attribute,oldValue:void 0};var o=this.getValues(t.parent,t.attribute);if(o&&o.length>0){var n=o.slice(0,o.length);l.oldValue=1===o.length?o[0]:o.slice(0,o.length),n.push(i),this._setValueOrValues(t.parent,t.attribute,n,!1),l.newValue=this.getValues(t.parent,t.attribute)}else this._setValueOrValues(t.parent,t.attribute,i,!1),l.newValue=i}else i[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(i);this._pending._newItems[r]=i;for(var m in a){if(m===this._storeRefPropName||m===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var s=a[m];if(e.isArray(s)||(s=[s]),i[m]=s,this.referenceIntegrity)for(var f=0;f<s.length;f++){var y=s[f];this.isItem(y)&&this._addReferenceToMap(y,i,m)}}return this.onNew(i,l),i},_removeArrayElement:function(e,a){var r=t.indexOf(e,a);return-1!=r?(e.splice(r,1),!0):!1},deleteItem:function(a){this._assert(!this._saveInProgress),this._assertIsItem(a);var r=a[this._itemNumPropName],d=this.getIdentity(a);if(this.referenceIntegrity){var i=this.getAttributes(a);a[this._reverseRefMap]&&(a["backup_"+this._reverseRefMap]=e.clone(a[this._reverseRefMap])),t.forEach(i,function(e){t.forEach(this.getValues(a,e),function(t){this.isItem(t)&&(a["backupRefs_"+this._reverseRefMap]||(a["backupRefs_"+this._reverseRefMap]=[]),a["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(t),attr:e}),this._removeReferenceFromMap(t,a,e))},this)},this);var l=a[this._reverseRefMap];if(l)for(var o in l){var n=null;if(n=this._itemsByIdentity?this._itemsByIdentity[o]:this._arrayOfAllItems[o])for(var m in l[o]){var s=this.getValues(n,m)||[],f=t.filter(s,function(e){return!(this.isItem(e)&&this.getIdentity(e)==d)},this);this._removeReferenceFromMap(a,n,m),f.length<s.length&&this._setValueOrValues(n,m,f,!0)}}}return this._arrayOfAllItems[r]=null,a[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[d],this._pending._deletedItems[d]=a,a[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,a),this.onDelete(a),!0},setValue:function(e,a,t){return this._setValueOrValues(e,a,t,!0)},setValues:function(e,a,t){return this._setValueOrValues(e,a,t,!0)},unsetAttribute:function(e,a){return this._setValueOrValues(e,a,[],!0)},_setValueOrValues:function(a,r,d,i){this._assert(!this._saveInProgress),this._assertIsItem(a),this._assert(e.isString(r)),this._assert("undefined"!=typeof d);var l=this._getIdentifierAttribute();if(r==l)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var o=this._getValueOrValues(a,r),n=this.getIdentity(a);if(!this._pending._modifiedItems[n]){var m={};for(var s in a)m[s]=s===this._storeRefPropName||s===this._itemNumPropName||s===this._rootItemPropName?a[s]:s===this._reverseRefMap?e.clone(a[s]):a[s].slice(0,a[s].length);this._pending._modifiedItems[n]=m}var f=!1;if(e.isArray(d)&&0===d.length){if(f=delete a[r],d=void 0,this.referenceIntegrity&&o){var y=o;e.isArray(y)||(y=[y]);for(var M=0;M<y.length;M++){var u=y[M];this.isItem(u)&&this._removeReferenceFromMap(u,a,r)}}}else{var v;if(v=e.isArray(d)?d.slice(0,d.length):[d],this.referenceIntegrity)if(o){var y=o;e.isArray(y)||(y=[y]);var h={};t.forEach(y,function(e){if(this.isItem(e)){var a=this.getIdentity(e);h[a.toString()]=!0}},this),t.forEach(v,function(e){if(this.isItem(e)){var t=this.getIdentity(e);h[t.toString()]?delete h[t.toString()]:this._addReferenceToMap(e,a,r)}},this);for(var c in h){var F;F=this._itemsByIdentity?this._itemsByIdentity[c]:this._arrayOfAllItems[c],this._removeReferenceFromMap(F,a,r)}}else for(var M=0;M<v.length;M++){var u=v[M];this.isItem(u)&&this._addReferenceToMap(u,a,r)}a[r]=v,f=!0}return i&&this.onSet(a,r,o,d),f},_addReferenceToMap:function(e,a,t){var r=this.getIdentity(a),d=e[this._reverseRefMap];d||(d=e[this._reverseRefMap]={});var i=d[r];i||(i=d[r]={}),i[t]=!0},_removeReferenceFromMap:function(e,a,t){var r,d=this.getIdentity(a),i=e[this._reverseRefMap];if(i){for(r in i)r==d&&(delete i[r][t],this._isEmpty(i[r])&&delete i[r]);this._isEmpty(i)&&delete e[this._reverseRefMap]}},_dumpReferenceMap:function(){var e;for(e=0;e<this._arrayOfAllItems.length;e++){var a=this._arrayOfAllItems[e];a&&a[this._reverseRefMap]}},_getValueOrValues:function(e,a){var t=void 0;if(this.hasAttribute(e,a)){var r=this.getValues(e,a);t=1==r.length?r[0]:r}return t},_flatten:function(a){if(this.isItem(a))return{_reference:this.getIdentity(a)};if("object"==typeof a)for(var t in this._datatypeMap){var r=this._datatypeMap[t];if(e.isObject(r)&&!e.isFunction(r)){if(a instanceof r.type){if(!r.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+t+"]");return{_type:t,_value:r.serialize(a)}}}else if(a instanceof r)return{_type:t,_value:a.toString()}}return a},_getNewFileContentString:function(){var e={},a=this._getIdentifierAttribute();a!==Number&&(e.identifier=a),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var t=0;t<this._arrayOfAllItems.length;++t){var d=this._arrayOfAllItems[t];if(null!==d){var i={};for(var l in d)if(l!==this._storeRefPropName&&l!==this._itemNumPropName&&l!==this._reverseRefMap&&l!==this._rootItemPropName){var o=this.getValues(d,l);if(1==o.length)i[l]=this._flatten(o[0]);else for(var n=[],m=0;m<o.length;++m)n.push(this._flatten(o[m])),i[l]=n}e.items.push(i)}}var s=!0;return r.toJson(e,s)},_isEmpty:function(a){var t=!0;if(e.isObject(a)){var r;for(r in a){t=!1;break}}else e.isArray(a)&&a.length>0&&(t=!1);return t},save:function(e){this._assert(!this._saveInProgress),this._saveInProgress=!0;var a=this,t=function(){if(a._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},a._saveInProgress=!1,e&&e.onComplete){var t=e.scope||d.global;e.onComplete.call(t)}},r=function(t){if(a._saveInProgress=!1,e&&e.onError){var r=e.scope||d.global;e.onError.call(r,t)}};if(this._saveEverything){var i=this._getNewFileContentString();this._saveEverything(t,r,i)}this._saveCustom&&this._saveCustom(t,r),this._saveEverything||this._saveCustom||t()},revert:function(){this._assert(!this._saveInProgress);var a;for(a in this._pending._modifiedItems){var r=this._pending._modifiedItems[a],d=null;d=this._itemsByIdentity?this._itemsByIdentity[a]:this._arrayOfAllItems[a],r[this._storeRefPropName]=this;for(var i in d)delete d[i];e.mixin(d,r)}var l;for(a in this._pending._deletedItems){l=this._pending._deletedItems[a],l[this._storeRefPropName]=this;var o=l[this._itemNumPropName];l["backup_"+this._reverseRefMap]&&(l[this._reverseRefMap]=l["backup_"+this._reverseRefMap],delete l["backup_"+this._reverseRefMap]),this._arrayOfAllItems[o]=l,this._itemsByIdentity&&(this._itemsByIdentity[a]=l),l[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(l)}for(a in this._pending._deletedItems)l=this._pending._deletedItems[a],l["backupRefs_"+this._reverseRefMap]&&(t.forEach(l["backupRefs_"+this._reverseRefMap],function(e){var a;a=this._itemsByIdentity?this._itemsByIdentity[e.id]:this._arrayOfAllItems[e.id],this._addReferenceToMap(a,l,e.attr)},this),delete l["backupRefs_"+this._reverseRefMap]);for(a in this._pending._newItems){var n=this._pending._newItems[a];n[this._storeRefPropName]=null,this._arrayOfAllItems[n[this._itemNumPropName]]=null,n[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,n),this._itemsByIdentity&&delete this._itemsByIdentity[a]}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var a=this.getIdentity(e);return new Boolean(this._pending._newItems[a]||this._pending._modifiedItems[a]||this._pending._deletedItems[a]).valueOf()}return!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)},onSet:function(){},onNew:function(){},onDelete:function(){},close:function(){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}})});//# sourceMappingURL=ItemFileWriteStore.js.map