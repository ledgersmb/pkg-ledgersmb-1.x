//>>built
define("dijit/form/_FormSelectWidget",["dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/data/util/sorter","dojo/_base/declare","dojo/dom","dojo/dom-class","dojo/_base/kernel","dojo/_base/lang","dojo/query","dojo/when","dojo/store/util/QueryResults","./_FormValueWidget"],function(e,t,a,i,r,d,o,n,l,s,m,u,f){var y=r("dijit.form._FormSelectWidget",f,{multiple:!1,options:null,store:null,_setStoreAttr:function(e){this._created&&this._deprecatedSetStore(e)},query:null,_setQueryAttr:function(e){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{query:e})},queryOptions:null,_setQueryOptionsAttr:function(e){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{queryOptions:e})},labelAttr:"",onFetch:null,sortByLabel:!0,loadChildrenOnOpen:!1,onLoadDeferred:null,getOptions:function(t){var a=this.options||[];return null==t?a:l.isArrayLike(t)?e.map(t,"return this.getOptions(item);",this):(l.isString(t)&&(t={value:t}),l.isObject(t)&&(e.some(a,function(e,a){for(var i in t)if(!(i in e)||e[i]!=t[i])return!1;return t=a,!0})||(t=-1)),t>=0&&t<a.length?a[t]:null)},addOption:function(t){e.forEach(l.isArrayLike(t)?t:[t],function(e){e&&l.isObject(e)&&this.options.push(e)},this),this._loadChildren()},removeOption:function(t){var a=this.getOptions(l.isArrayLike(t)?t:[t]);e.forEach(a,function(t){t&&(this.options=e.filter(this.options,function(e){return e.value!==t.value||e.label!==t.label}),this._removeOptionItem(t))},this),this._loadChildren()},updateOption:function(t){e.forEach(l.isArrayLike(t)?t:[t],function(e){var t,a=this.getOptions({value:e.value});if(a)for(t in e)a[t]=e[t]},this),this._loadChildren()},setStore:function(e,t,a){n.deprecated(this.declaredClass+"::setStore(store, selectedValue, fetchArgs) is deprecated. Use set('query', fetchArgs.query), set('queryOptions', fetchArgs.queryOptions), set('store', store), or set('value', selectedValue) instead.","","2.0"),this._deprecatedSetStore(e,t,a)},_deprecatedSetStore:function(r,d,o){var n=this.store;if(o=o||{},n!==r){for(var s;s=this._notifyConnections.pop();)s.remove();r.get||(l.mixin(r,{_oldAPI:!0,get:function(e){var a=new t;return this.fetchItemByIdentity({identity:e,onItem:function(e){a.resolve(e)},onError:function(e){a.reject(e)}}),a.promise},query:function(e,a){var i=new t(function(){r.abort&&r.abort()});i.total=new t;var r=this.fetch(l.mixin({query:e,onBegin:function(e){i.total.resolve(e)},onComplete:function(e){i.resolve(e)},onError:function(e){i.reject(e)}},a));return new u(i)}}),r.getFeatures()["dojo.data.api.Notification"]&&(this._notifyConnections=[a.after(r,"onNew",l.hitch(this,"_onNewItem"),!0),a.after(r,"onDelete",l.hitch(this,"_onDeleteItem"),!0),a.after(r,"onSet",l.hitch(this,"_onSetItem"),!0)])),this._set("store",r)}return this.options&&this.options.length&&this.removeOption(this.options),this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),o.query&&this._set("query",o.query),o.queryOptions&&this._set("queryOptions",o.queryOptions),r&&r.query&&(this._loadingStore=!0,this.onLoadDeferred=new t,this._queryRes=r.query(this.query,this.queryOptions),m(this._queryRes,l.hitch(this,function(t){if(this.sortByLabel&&!o.sort&&t.length)if(r.getValue)t.sort(i.createSortFunction([{attribute:r.getLabelAttributes(t[0])[0]}],r));else{var a=this.labelAttr;t.sort(function(e,t){return e[a]>t[a]?1:t[a]>e[a]?-1:0})}o.onFetch&&(t=o.onFetch.call(this,t,o)),e.forEach(t,function(e){this._addOptionForItem(e)},this),this._queryRes.observe&&(this._observeHandle=this._queryRes.observe(l.hitch(this,function(e,t,a){t==a?this._onSetItem(e):(-1!=t&&this._onDeleteItem(e),-1!=a&&this._onNewItem(e))}),!0)),this._loadingStore=!1,this.set("value","_pendingValue"in this?this._pendingValue:d),delete this._pendingValue,this.loadChildrenOnOpen?this._pseudoLoadChildren(t):this._loadChildren(),this.onLoadDeferred.resolve(!0),this.onSetStore()}),l.hitch(this,function(e){console.error("dijit.form.Select: "+e.toString()),this.onLoadDeferred.reject(e)}))),n},_setValueAttr:function(t,a){if(this._onChangeActive||(a=null),this._loadingStore)return void(this._pendingValue=t);if(null!=t){t=l.isArrayLike(t)?e.map(t,function(e){return l.isObject(e)?e:{value:e}}):l.isObject(t)?[t]:[{value:t}],t=e.filter(this.getOptions(t),function(e){return e&&e.value});var i=this.getOptions()||[];this.multiple||t[0]&&t[0].value||!i.length||(t[0]=i[0]),e.forEach(i,function(a){a.selected=e.some(t,function(e){return e.value===a.value})});var r=e.map(t,function(e){return e.value});if("undefined"!=typeof r&&"undefined"!=typeof r[0]){var d=e.map(t,function(e){return e.label});this._setDisplay(this.multiple?d:d[0]),this.inherited(arguments,[this.multiple?r:r[0],a]),this._updateSelection()}}},_getDisplayedValueAttr:function(){var t=e.map([].concat(this.get("selectedOptions")),function(e){return e&&"label"in e?e.label:e?e.value:null},this);return this.multiple?t:t[0]},_setDisplayedValueAttr:function(e){this.set("value",this.getOptions("string"==typeof e?{label:e}:e))},_loadChildren:function(){this._loadingStore||(e.forEach(this._getChildren(),function(e){e.destroyRecursive()}),e.forEach(this.options,this._addOptionItem,this),this._updateSelection())},_updateSelection:function(){this.focusedChild=null,this._set("value",this._getValueFromOpts());var t=[].concat(this.value);if(t&&t[0]){var a=this;e.forEach(this._getChildren(),function(i){var r=e.some(t,function(e){return i.option&&e===i.option.value});r&&!a.multiple&&(a.focusedChild=i),o.toggle(i.domNode,this.baseClass.replace(/\s+|$/g,"SelectedOption "),r),i.domNode.setAttribute("aria-selected",r?"true":"false")},this)}},_getValueFromOpts:function(){var t=this.getOptions()||[];if(!this.multiple&&t.length){var a=e.filter(t,function(e){return e.selected})[0];return a&&a.value?a.value:(t[0].selected=!0,t[0].value)}return this.multiple?e.map(e.filter(t,function(e){return e.selected}),function(e){return e.value})||[]:""},_onNewItem:function(e,t){t&&t.parent||this._addOptionForItem(e)},_onDeleteItem:function(e){var t=this.store;this.removeOption({value:t.getIdentity(e)})},_onSetItem:function(e){this.updateOption(this._getOptionObjForItem(e))},_getOptionObjForItem:function(e){var t=this.store,a=this.labelAttr&&this.labelAttr in e?e[this.labelAttr]:t.getLabel(e),i=a?t.getIdentity(e):null;return{value:i,label:a,item:e}},_addOptionForItem:function(e){var t=this.store;if(t.isItemLoaded&&!t.isItemLoaded(e))return void t.loadItem({item:e,onItem:function(e){this._addOptionForItem(e)},scope:this});var a=this._getOptionObjForItem(e);this.addOption(a)},constructor:function(e){this._oValue=(e||{}).value||null,this._notifyConnections=[]},buildRendering:function(){this.inherited(arguments),d.setSelectable(this.focusNode,!1)},_fillContent:function(){this.options||(this.options=this.srcNodeRef?s("> *",this.srcNodeRef).map(function(e){return"separator"===e.getAttribute("type")?{value:"",label:"",selected:!1,disabled:!1}:{value:e.getAttribute("data-"+n._scopeName+"-value")||e.getAttribute("value"),label:String(e.innerHTML),selected:e.getAttribute("selected")||!1,disabled:e.getAttribute("disabled")||!1}},this):[]),this.value?this.multiple&&"string"==typeof this.value&&this._set("value",this.value.split(",")):this._set("value",this._getValueFromOpts())},postCreate:function(){this.inherited(arguments),a.after(this,"onChange",l.hitch(this,"_updateSelection"));var e=this.store;e&&(e.getIdentity||e.getFeatures()["dojo.data.api.Identity"])&&(this.store=null,this._deprecatedSetStore(e,this._oValue,{query:this.query,queryOptions:this.queryOptions})),this._storeInitialized=!0},startup:function(){this._loadChildren(),this.inherited(arguments)},destroy:function(){for(var e;e=this._notifyConnections.pop();)e.remove();this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),this.inherited(arguments)},_addOptionItem:function(){},_removeOptionItem:function(){},_setDisplay:function(){},_getChildren:function(){return[]},_getSelectedOptionsAttr:function(){return this.getOptions({selected:!0})},_pseudoLoadChildren:function(){},onSetStore:function(){}});return y});//# sourceMappingURL=_FormSelectWidget.js.map