//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(e,a,t,r,i,d){var l=null;return a("dojo.store.DataStore",l,{target:"",constructor:function(a){if(e.mixin(this,a),!("idProperty"in a)){var t;try{t=this.store.getIdentityAttributes()}catch(r){}this.idProperty=(e.isArray(t)?t[0]:t)||this.idProperty}var i=this.store.getFeatures();i["dojo.data.api.Read"]||(this.get=null),i["dojo.data.api.Identity"]||(this.getIdentity=null),i["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:d,_objectConverter:function(e){function a(e){for(var i={},d=t.getAttributes(e),l=0;l<d.length;l++){var o=d[l],n=t.getValues(e,o);if(n.length>1){for(var m=0;m<n.length;m++){var s=n[m];"object"==typeof s&&t.isItem(s)&&(n[m]=a(s))}s=n}else{var s=t.getValue(e,o);"object"==typeof s&&t.isItem(s)&&(s=a(s))}i[d[l]]=s}return r in i||!t.getIdentity||(i[r]=t.getIdentity(e)),i}var t=this.store,r=this.idProperty;return function(t){return e(t&&a(t))}},get:function(e){var a,r,i=new t;if(this.store.fetchItemByIdentity({identity:e,onItem:this._objectConverter(function(e){i.resolve(a=e)}),onError:function(e){i.reject(r=e)}}),void 0!==a)return null==a?void 0:a;if(r)throw r;return i.promise},put:function(e,a){a=a||{};var r="undefined"!=typeof a.id?a.id:this.getIdentity(e),i=this.store,d=this.idProperty,l=new t;if("undefined"==typeof r){var o=i.newItem(e);i.save({onComplete:function(){l.resolve(o)},onError:function(e){l.reject(e)}})}else i.fetchItemByIdentity({identity:r,onItem:function(t){if(t){if(a.overwrite===!1)return l.reject(new Error("Overwriting existing object not allowed"));for(var r in e)r!=d&&e.hasOwnProperty(r)&&i.getValue(t,r)!=e[r]&&i.setValue(t,r,e[r])}else{if(a.overwrite===!0)return l.reject(new Error("Creating new object not allowed"));var t=i.newItem(e)}i.save({onComplete:function(){l.resolve(t)},onError:function(e){l.reject(e)}})},onError:function(e){l.reject(e)}});return l.promise},add:function(e,a){return(a=a||{}).overwrite=!1,this.put(e,a)},remove:function(e){var a=this.store,r=new t;return this.store.fetchItemByIdentity({identity:e,onItem:function(e){try{null==e?r.resolve(!1):(a.deleteItem(e),a.save(),r.resolve(!0))}catch(t){r.reject(t)}},onError:function(e){r.reject(e)}}),r.promise},query:function(a,d){var l,o=new t(function(){l.abort&&l.abort()});o.total=new t;var n=this._objectConverter(function(e){return e});return l=this.store.fetch(e.mixin({query:a,onBegin:function(e){o.total.resolve(e)},onComplete:function(e){o.resolve(r.map(e,n))},onError:function(e){o.reject(e)}},d)),i(o)},getIdentity:function(e){return e[this.idProperty]}})});//# sourceMappingURL=DataStore.js.map