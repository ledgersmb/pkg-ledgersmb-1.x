//>>built
define("dijit/_editor/plugins/ViewSource",["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/i18n","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/window","../../focus","../_Plugin","../../form/ToggleButton","../..","../../registry","dojo/i18n!../nls/commands"],function(e,t,a,r,i,d,o,n,l,s,m,f,u,y,h,c,v,M){var g=a("dijit._editor.plugins.ViewSource",h,{stripScripts:!0,stripComments:!0,stripIFrames:!0,stripEventHandlers:!0,readOnly:!1,_fsPlugin:null,toggle:function(){f("webkit")&&(this._vsFocused=!0),this.button.set("checked",!this.button.get("checked"))},_initButton:function(){var e=n.getLocalization("dijit._editor","commands"),t=this.editor;this.button=new c({label:e.viewSource,ownerDocument:t.ownerDocument,dir:t.dir,lang:t.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:s.hitch(this,"_showSource")}),this.button.set("readOnly",!1)},setEditor:function(e){this.editor=e,this._initButton(),this.editor.addKeyHandler(l.F12,!0,!0,s.hitch(this,function(e){this.button.focus(),this.toggle(),e.stopPropagation(),e.preventDefault(),setTimeout(s.hitch(this,function(){this.editor.focused&&this.editor.focus()}),100)}))},_showSource:function(a){var r,i=this.editor,d=i._plugins;this._sourceShown=a;var n=this;try{if(this.sourceArea||this._createSourceView(),a){i._sourceQueryCommandEnabled=i.queryCommandEnabled,i.queryCommandEnabled=function(e){return"viewsource"===e.toLowerCase()},this.editor.onDisplayChanged(),r=i.get("value"),r=this._filter(r),i.set("value",r),e.forEach(d,function(e){!e||e instanceof g||!e.isInstanceOf(h)||e.set("disabled",!0)}),this._fsPlugin&&(this._fsPlugin._getAltViewNode=function(){return n.sourceArea}),this.sourceArea.value=r,this.sourceArea.style.height=i.iframe.style.height,this.sourceArea.style.width=i.iframe.style.width,i.iframe.parentNode.style.position="relative",o.set(i.iframe,{position:"absolute",top:0,visibility:"hidden"}),o.set(this.sourceArea,{display:"block"});var l=function(){var e=u.getBox(i.ownerDocument);if("_prevW"in this&&"_prevH"in this){if(e.w===this._prevW&&e.h===this._prevH)return;this._prevW=e.w,this._prevH=e.h}else this._prevW=e.w,this._prevH=e.h;this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizer=setTimeout(s.hitch(this,function(){delete this._resizer,this._resize()}),10)};this._resizeHandle=m(window,"resize",s.hitch(this,l)),setTimeout(s.hitch(this,this._resize),100),this.editor.onNormalizedDisplayChanged(),this.editor.__oldGetValue=this.editor.getValue,this.editor.getValue=s.hitch(this,function(){var e=this.sourceArea.value;return e=this._filter(e)}),this._setListener=t.after(this.editor,"setValue",s.hitch(this,function(e){e=e||"",e=this._filter(e),this.sourceArea.value=e}),!0)}else{if(!i._sourceQueryCommandEnabled)return;this._setListener.remove(),delete this._setListener,this._resizeHandle.remove(),delete this._resizeHandle,this.editor.__oldGetValue&&(this.editor.getValue=this.editor.__oldGetValue,delete this.editor.__oldGetValue),i.queryCommandEnabled=i._sourceQueryCommandEnabled,this._readOnly||(r=this.sourceArea.value,r=this._filter(r),i.beginEditing(),i.set("value",r),i.endEditing()),e.forEach(d,function(e){e&&e.isInstanceOf(h)&&e.set("disabled",!1)}),o.set(this.sourceArea,"display","none"),o.set(i.iframe,{position:"relative",visibility:"visible"}),delete i._sourceQueryCommandEnabled,this.editor.onDisplayChanged()}setTimeout(s.hitch(this,function(){var e=i.domNode.parentNode;if(e){var t=M.getEnclosingWidget(e);t&&t.resize&&t.resize()}i.resize()}),300)}catch(f){}},updateState:function(){this.button.set("disabled",this.get("disabled"))},_resize:function(){var e=this.editor,t=e.getHeaderHeight(),a=e.getFooterHeight(),r=d.position(e.domNode),i=d.getPadBorderExtents(e.iframe.parentNode),o=d.getMarginExtents(e.iframe.parentNode),n=d.getPadBorderExtents(e.domNode),l={w:r.w-n.w,h:r.h-(t+n.h+a)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var s=u.getBox(e.ownerDocument);l.w=s.w-n.w,l.h=s.h-(t+n.h+a)}d.setMarginBox(this.sourceArea,{w:Math.round(l.w-(i.w+o.w)),h:Math.round(l.h-(i.h+o.h))})},_createSourceView:function(){var e=this.editor,t=e._plugins;this.sourceArea=i.create("textarea"),this.readOnly&&(r.set(this.sourceArea,"readOnly",!0),this._readOnly=!0),o.set(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),r.set(this.sourceArea,"aria-label",this.editor.id),i.place(this.sourceArea,e.iframe,"before"),f("ie")&&e.iframe.parentNode.lastChild!==e.iframe&&o.set(e.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),e._viewsource_oldFocus=e.focus;var a=this;e.focus=function(){if(a._sourceShown)a.setSourceAreaCaret();else try{this._vsFocused?(delete this._vsFocused,y.focus(e.editNode)):e._viewsource_oldFocus()}catch(t){}};var d,n;for(d=0;d<t.length;d++)if(n=t[d],n&&("dijit._editor.plugins.FullScreen"===n.declaredClass||n.declaredClass===v._scopeName+"._editor.plugins.FullScreen")){this._fsPlugin=n;break}this._fsPlugin&&(this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode,this._fsPlugin._getAltViewNode=function(){return a._sourceShown?a.sourceArea:this._viewsource_getAltViewNode()}),this.own(m(this.sourceArea,"keydown",s.hitch(this,function(t){this._sourceShown&&t.keyCode==l.F12&&t.ctrlKey&&t.shiftKey&&(this.button.focus(),this.button.set("checked",!1),setTimeout(s.hitch(this,function(){e.focus()}),100),t.stopPropagation(),t.preventDefault())})))},_stripScripts:function(e){return e&&(e=e.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/gi,""),e=e.replace(/<\s*script\b([^<>]|\s)*>?/gi,""),e=e.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/gi,"")),e},_stripComments:function(e){return e&&(e=e.replace(/<!--(.|\s){1,}?-->/g,"")),e},_stripIFrames:function(e){return e&&(e=e.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/gi,"")),e},_stripEventHandlers:function(e){if(e){var t=e.match(/<[a-z]+?\b(.*?on.*?(['"]).*?\2.*?)+>/gim);if(t)for(var a=0,r=t.length;r>a;a++){var i=t[a],d=i.replace(/\s+on[a-z]*\s*=\s*(['"])(.*?)\1/gim,"");e=e.replace(i,d)}}return e},_filter:function(e){return e&&(this.stripScripts&&(e=this._stripScripts(e)),this.stripComments&&(e=this._stripComments(e)),this.stripIFrames&&(e=this._stripIFrames(e)),this.stripEventHandlers&&(e=this._stripEventHandlers(e))),e},setSourceAreaCaret:function(){var e=this.sourceArea;if(y.focus(e),this._sourceShown&&!this.readOnly)if(e.setSelectionRange)e.setSelectionRange(0,0);else if(this.sourceArea.createTextRange){var t=e.createTextRange();t.collapse(!0),t.moveStart("character",-99999),t.moveStart("character",0),t.moveEnd("character",0),t.select()}},destroy:function(){this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizeHandle&&(this._resizeHandle.remove(),delete this._resizeHandle),this._setListener&&(this._setListener.remove(),delete this._setListener),this.inherited(arguments)}});return h.registry.viewSource=h.registry.viewsource=function(e){return new g({readOnly:"readOnly"in e?e.readOnly:!1,stripComments:"stripComments"in e?e.stripComments:!0,stripScripts:"stripScripts"in e?e.stripScripts:!0,stripIFrames:"stripIFrames"in e?e.stripIFrames:!0,stripEventHandlers:"stripEventHandlers"in e?e.stripEventHandlers:!0})},g});//# sourceMappingURL=ViewSource.js.map