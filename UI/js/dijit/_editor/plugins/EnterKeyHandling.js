//>>built
define("dijit/_editor/plugins/EnterKeyHandling",["dojo/_base/declare","dojo/dom-construct","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../_Plugin","../RichText","../range"],function(e,t,a,r,i,d,o,n,l,s,m){return e("dijit._editor.plugins.EnterKeyHandling",l,{blockNodeForEnter:"BR",constructor:function(e){e&&("blockNodeForEnter"in e&&(e.blockNodeForEnter=e.blockNodeForEnter.toUpperCase()),r.mixin(this,e))},setEditor:function(e){if(this.editor!==e)if(this.editor=e,"BR"==this.blockNodeForEnter)this.editor.customUndo=!0,e.onLoadDeferred.then(r.hitch(this,function(t){return this.own(i(e.document,"keydown",r.hitch(this,function(e){if(e.keyCode==a.ENTER){var t=r.mixin({},e);t.shiftKey=!0,this.handleEnterKey(t)||(e.stopPropagation(),e.preventDefault())}}))),d("ie")>=9&&d("ie")<=10&&this.own(i(e.document,"paste",r.hitch(this,function(){setTimeout(r.hitch(this,function(){var e=this.editor.document.selection.createRange();e.move("character",-1),e.select(),e.move("character",1),e.select()}),0)}))),t}));else if(this.blockNodeForEnter){var t=r.hitch(this,"handleEnterKey");e.addKeyHandler(13,0,0,t),e.addKeyHandler(13,0,1,t),this.own(this.editor.on("KeyPressed",r.hitch(this,"onKeyPressed")))}},onKeyPressed:function(){if(this._checkListLater){if(this.editor.selection.isCollapsed()){var e=this.editor.selection.getAncestorElement("LI");if(e){d("mozilla")&&"LI"==e.parentNode.parentNode.nodeName&&(e=e.parentNode.parentNode);var t=e.firstChild;if(t&&1==t.nodeType&&("UL"==t.nodeName||"OL"==t.nodeName)){e.insertBefore(t.ownerDocument.createTextNode(" "),t);var a=m.create(this.editor.window);a.setStart(e.firstChild,0);var r=m.getSelection(this.editor.window,!0);r.removeAllRanges(),r.addRange(a)}}else{s.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var i=this.editor.selection.getAncestorElement(this.blockNodeForEnter);if(i){if(i.innerHTML=this.bogusHtmlContent,d("ie")<=9){var o=this.editor.document.selection.createRange();o.move("character",-1),o.select()}}else console.error("onKeyPressed: Cannot find the new block node")}}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var a,r,i,o,l,f,u,y,h,c=this.editor.document;if(e.shiftKey){var v=this.editor.selection.getParentElement(),M=m.getAncestor(v,this.blockNodes);if(M){if("LI"==M.tagName)return!0;if(a=m.getSelection(this.editor.window),r=a.getRangeAt(0),r.collapsed||(r.deleteContents(),a=m.getSelection(this.editor.window),r=a.getRangeAt(0)),m.atBeginningOfContainer(M,r.startContainer,r.startOffset))u=c.createElement("br"),i=m.create(this.editor.window),M.insertBefore(u,M.firstChild),i.setStartAfter(u),a.removeAllRanges(),a.addRange(i);else{if(!m.atEndOfContainer(M,r.startContainer,r.startOffset))return y=r.startContainer,y&&3==y.nodeType?(h=y.nodeValue,o=c.createTextNode(h.substring(0,r.startOffset)),l=c.createTextNode(h.substring(r.startOffset)),f=c.createElement("br"),""==l.nodeValue&&d("webkit")&&(l=c.createTextNode(" ")),t.place(o,y,"after"),t.place(f,o,"after"),t.place(l,f,"after"),t.destroy(y),i=m.create(this.editor.window),i.setStart(l,0),a.removeAllRanges(),a.addRange(i),!1):!0;i=m.create(this.editor.window),u=c.createElement("br"),M.appendChild(u),M.appendChild(c.createTextNode(" ")),i.setStart(M.lastChild,0),a.removeAllRanges(),a.addRange(i)}}else if(a=m.getSelection(this.editor.window),a.rangeCount){if(r=a.getRangeAt(0),r&&r.startContainer)if(r.collapsed||(r.deleteContents(),a=m.getSelection(this.editor.window),r=a.getRangeAt(0)),y=r.startContainer,y&&3==y.nodeType){var g=r.startOffset;y.length<g&&(j=this._adjustNodeAndOffset(y,g),y=j.node,g=j.offset),h=y.nodeValue,o=c.createTextNode(h.substring(0,g)),l=c.createTextNode(h.substring(g)),f=c.createElement("br"),l.length||(l=c.createTextNode(" ")),o.length?t.place(o,y,"after"):o=y,t.place(f,o,"after"),t.place(l,f,"after"),t.destroy(y),i=m.create(this.editor.window),i.setStart(l,0),i.setEnd(l,l.length),a.removeAllRanges(),a.addRange(i),this.editor.selection.collapse(!0)}else{var p;r.startOffset>=0&&(p=y.childNodes[r.startOffset]);var f=c.createElement("br"),l=c.createTextNode(" ");p?(t.place(f,p,"before"),t.place(l,f,"after")):(y.appendChild(f),y.appendChild(l)),i=m.create(this.editor.window),i.setStart(l,0),i.setEnd(l,l.length),a.removeAllRanges(),a.addRange(i),this.editor.selection.collapse(!0)}}else s.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var b=!0;a=m.getSelection(this.editor.window),r=a.getRangeAt(0),r.collapsed||(r.deleteContents(),a=m.getSelection(this.editor.window),r=a.getRangeAt(0));var w=m.getBlockAncestor(r.endContainer,null,this.editor.editNode),k=w.blockNode;if(this._checkListLater=k&&("LI"==k.nodeName||"LI"==k.parentNode.nodeName))return d("mozilla")&&(this._pressedEnterInBlock=k),/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(k.innerHTML)&&(k.innerHTML="",d("webkit")&&(i=m.create(this.editor.window),i.setStart(k,0),a.removeAllRanges(),a.addRange(i)),this._checkListLater=!1),!0;if(!w.blockNode||w.blockNode===this.editor.editNode){try{s.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(F){}if(w={blockNode:this.editor.selection.getAncestorElement(this.blockNodeForEnter),blockContainer:this.editor.editNode},w.blockNode){if(w.blockNode!=this.editor.editNode&&!(w.blockNode.textContent||w.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(w.blockNode),!1}else w.blockNode=this.editor.editNode;a=m.getSelection(this.editor.window),r=a.getRangeAt(0)}var I=c.createElement(this.blockNodeForEnter);I.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(w.blockNode);var E=r.endOffset,G=r.endContainer;if(G.length<E){var j=this._adjustNodeAndOffset(G,E);G=j.node,E=j.offset}if(m.atEndOfContainer(w.blockNode,G,E))w.blockNode===w.blockContainer?w.blockNode.appendChild(I):t.place(I,w.blockNode,"after"),b=!1,i=m.create(this.editor.window),i.setStart(I,0),a.removeAllRanges(),a.addRange(i),this.editor.height&&n.scrollIntoView(I);else if(m.atBeginningOfContainer(w.blockNode,r.startContainer,r.startOffset))t.place(I,w.blockNode,w.blockNode===w.blockContainer?"first":"before"),I.nextSibling&&this.editor.height&&(i=m.create(this.editor.window),i.setStart(I.nextSibling,0),a.removeAllRanges(),a.addRange(i),n.scrollIntoView(I.nextSibling)),b=!1;else{w.blockNode===w.blockContainer?w.blockNode.appendChild(I):t.place(I,w.blockNode,"after"),b=!1,w.blockNode.style&&I.style&&w.blockNode.style.cssText&&(I.style.cssText=w.blockNode.style.cssText),y=r.startContainer;var _;if(y&&3==y.nodeType){var A,z;E=r.endOffset,y.length<E&&(j=this._adjustNodeAndOffset(y,E),y=j.node,E=j.offset),h=y.nodeValue,o=c.createTextNode(h.substring(0,E)),l=c.createTextNode(h.substring(E,h.length)),t.place(o,y,"before"),t.place(l,y,"after"),t.destroy(y);for(var T=o.parentNode;T!==w.blockNode;){var S=T.tagName,N=c.createElement(S);for(T.style&&N.style&&T.style.cssText&&(N.style.cssText=T.style.cssText),"FONT"===T.tagName&&(T.color&&(N.color=T.color),T.face&&(N.face=T.face),T.size&&(N.size=T.size)),A=l;A;)z=A.nextSibling,N.appendChild(A),A=z;t.place(N,T,"after"),o=T,l=N,T=T.parentNode}for(A=l,(1==A.nodeType||3==A.nodeType&&A.nodeValue)&&(I.innerHTML=""),_=A;A;)z=A.nextSibling,I.appendChild(A),A=z}i=m.create(this.editor.window);var Q,x=_;if("BR"!==this.blockNodeForEnter){for(;x;)Q=x,z=x.firstChild,x=z;Q&&Q.parentNode?(I=Q.parentNode,i.setStart(I,0),a.removeAllRanges(),a.addRange(i),this.editor.height&&n.scrollIntoView(I),d("mozilla")&&(this._pressedEnterInBlock=w.blockNode)):b=!0}else i.setStart(I,0),a.removeAllRanges(),a.addRange(i),this.editor.height&&n.scrollIntoView(I),d("mozilla")&&(this._pressedEnterInBlock=w.blockNode)}return b},_adjustNodeAndOffset:function(e,t){for(;e.length<t&&e.nextSibling&&3==e.nextSibling.nodeType;)t-=e.length,e=e.nextSibling;return{node:e,offset:t}},removeTrailingBr:function(e){var a=/P|DIV|LI/i.test(e.tagName)?e:this.editor.selection.getParentOfType(e,["P","DIV","LI"]);a&&(a.lastChild&&(a.childNodes.length>1&&3==a.lastChild.nodeType&&/^[\s\xAD]*$/.test(a.lastChild.nodeValue)||"BR"==a.lastChild.tagName)&&t.destroy(a.lastChild),a.childNodes.length||(a.innerHTML=this.bogusHtmlContent))}})});//# sourceMappingURL=EnterKeyHandling.js.map