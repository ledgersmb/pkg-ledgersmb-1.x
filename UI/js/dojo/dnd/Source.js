//>>built
define("dojo/dnd/Source",["../_base/array","../_base/declare","../_base/kernel","../_base/lang","../dom-class","../dom-geometry","../mouse","../ready","../topic","./common","./Selector","./Manager"],function(e,a,t,r,d,i,l,o,n,m,s,f){t.isAsync||o(0,function(){var e=["dojo/dnd/AutoSource","dojo/dnd/Target"];require(e)});var y=a("dojo.dnd.Source",s,{isSource:!0,horizontal:!1,copyOnly:!1,selfCopy:!1,selfAccept:!0,skipForm:!1,withHandles:!1,autoSync:!1,delay:0,accept:["text"],generateText:!0,constructor:function(e,a){r.mixin(this,r.mixin({},a));var t=this.accept;if(t.length){this.accept={};for(var i=0;i<t.length;++i)this.accept[t[i]]=1}this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.before=!0,this._lastX=0,this._lastY=0,this.sourceState="",this.isSource&&d.add(this.node,"dojoDndSource"),this.targetState="",this.accept&&d.add(this.node,"dojoDndTarget"),this.horizontal&&d.add(this.node,"dojoDndHorizontal"),this.topics=[n.subscribe("/dnd/source/over",r.hitch(this,"onDndSourceOver")),n.subscribe("/dnd/start",r.hitch(this,"onDndStart")),n.subscribe("/dnd/drop",r.hitch(this,"onDndDrop")),n.subscribe("/dnd/cancel",r.hitch(this,"onDndCancel"))]},checkAcceptance:function(e,a){if(this==e)return!this.copyOnly||this.selfAccept;for(var t=0;t<a.length;++t){for(var r=e.getItem(a[t].id).type,d=!1,i=0;i<r.length;++i)if(r[i]in this.accept){d=!0;break}if(!d)return!1}return!0},copyState:function(e,a){return e?!0:(arguments.length<2&&(a=this==f.manager().target),a?this.copyOnly?this.selfCopy:!1:this.copyOnly)},destroy:function(){y.superclass.destroy.call(this),e.forEach(this.topics,function(e){e.remove()}),this.targetAnchor=null},onMouseMove:function(e){if(!this.isDragging||"Disabled"!=this.targetState){y.superclass.onMouseMove.call(this,e);var a=f.manager();if(!this.isDragging&&this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>this.delay||Math.abs(e.pageY-this._lastY)>this.delay)){var t=this.getSelectedNodes();t.length&&a.startDrag(this,t,this.copyState(m.getCopyKeyState(e),!0))}if(this.isDragging){var r=!1;this.current&&(this.targetBox&&this.targetAnchor==this.current||(this.targetBox=i.position(this.current,!0)),r=this.horizontal?e.pageX-this.targetBox.x<this.targetBox.w/2==i.isBodyLtr(this.current.ownerDocument):e.pageY-this.targetBox.y<this.targetBox.h/2),(this.current!=this.targetAnchor||r!=this.before)&&(this._markTargetAnchor(r),a.canDrop(!(this.current&&a.source==this&&this.current.id in this.selection)))}}},onMouseDown:function(e){this.mouseDown||!this._legalMouseDown(e)||this.skipForm&&m.isFormElement(e)||(this.mouseDown=!0,this._lastX=e.pageX,this._lastY=e.pageY,y.superclass.onMouseDown.call(this,e))},onMouseUp:function(e){this.mouseDown&&(this.mouseDown=!1,y.superclass.onMouseUp.call(this,e))},onDndSourceOver:function(e){if(this!==e)this.mouseDown=!1,this.targetAnchor&&this._unmarkTargetAnchor();else if(this.isDragging){var a=f.manager();a.canDrop(!("Disabled"==this.targetState||this.current&&a.source==this&&this.current.id in this.selection))}},onDndStart:function(e,a,t){this.autoSync&&this.sync(),this.isSource&&this._changeState("Source",this==e?t?"Copied":"Moved":"");var r=this.accept&&this.checkAcceptance(e,a);this._changeState("Target",r?"":"Disabled"),this==e&&f.manager().overSource(this),this.isDragging=!0},onDndDrop:function(e,a,t,r){this==r&&this.onDrop(e,a,t),this.onDndCancel()},onDndCancel:function(){this.targetAnchor&&(this._unmarkTargetAnchor(),this.targetAnchor=null),this.before=!0,this.isDragging=!1,this.mouseDown=!1,this._changeState("Source",""),this._changeState("Target","")},onDrop:function(e,a,t){this!=e?this.onDropExternal(e,a,t):this.onDropInternal(a,t)},onDropExternal:function(e,a,t){var r=this._normalizedCreator;this._normalizedCreator=this.creator?function(a,t){return r.call(this,e.getItem(a.id).data,t)}:t?function(a){var t=e.getItem(a.id),r=a.cloneNode(!0);return r.id=m.getUniqueId(),{node:r,data:t.data,type:t.type}}:function(a){var t=e.getItem(a.id);return e.delItem(a.id),{node:a,data:t.data,type:t.type}},this.selectNone(),t||this.creator||e.selectNone(),this.insertNodes(!0,a,this.before,this.current),!t&&this.creator&&e.deleteSelectedNodes(),this._normalizedCreator=r},onDropInternal:function(e,a){var t=this._normalizedCreator;if(!(this.current&&this.current.id in this.selection)){if(a)this._normalizedCreator=this.creator?function(e,a){return t.call(this,this.getItem(e.id).data,a)}:function(e){var a=this.getItem(e.id),t=e.cloneNode(!0);return t.id=m.getUniqueId(),{node:t,data:a.data,type:a.type}};else{if(!this.current)return;this._normalizedCreator=function(e){var a=this.getItem(e.id);return{node:e,data:a.data,type:a.type}}}this._removeSelection(),this.insertNodes(!0,e,this.before,this.current),this._normalizedCreator=t}},onDraggingOver:function(){},onDraggingOut:function(){},onOverEvent:function(){y.superclass.onOverEvent.call(this),f.manager().overSource(this),this.isDragging&&"Disabled"!=this.targetState&&this.onDraggingOver()},onOutEvent:function(){y.superclass.onOutEvent.call(this),f.manager().outSource(this),this.isDragging&&"Disabled"!=this.targetState&&this.onDraggingOut()},_markTargetAnchor:function(e){(this.current!=this.targetAnchor||this.before!=e)&&(this.targetAnchor&&this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=this.current,this.targetBox=null,this.before=e,this.targetAnchor&&this._addItemClass(this.targetAnchor,this.before?"Before":"After"))},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=null,this.targetBox=null,this.before=!0)},_markDndStatus:function(e){this._changeState("Source",e?"Copied":"Moved")},_legalMouseDown:function(e){if("touchstart"!=e.type&&!l.isLeft(e))return!1;if(!this.withHandles)return!0;for(var a=e.target;a&&a!==this.node;a=a.parentNode){if(d.contains(a,"dojoDndHandle"))return!0;if(d.contains(a,"dojoDndItem")||d.contains(a,"dojoDndIgnore"))break}return!1}});return y});//# sourceMappingURL=Source.js.map