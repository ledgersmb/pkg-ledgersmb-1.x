//>>built
define("dojo/data/ItemFileReadStore",["../_base/kernel","../_base/lang","../_base/declare","../_base/array","../_base/xhr","../Evented","./util/filter","./util/simpleFetch","../date/stamp"],function(e,a,t,r,d,i,l,o,n){var m=t("dojo.data.ItemFileReadStore",[i],{constructor:function(e){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=e.url,this._ccUrl=e.url,this.url=e.url,this._jsonData=e.data,this.data=null,this._datatypeMap=e.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(e){return n.fromISOString(e)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._reverseRefMap="_RRM",this._loadInProgress=!1,this._queuedFetches=[],void 0!==e.urlPreventCache&&(this.urlPreventCache=e.urlPreventCache?!0:!1),void 0!==e.hierarchical&&(this.hierarchical=e.hierarchical?!0:!1),e.clearOnClose&&(this.clearOnClose=!0),"failOk"in e&&(this.failOk=e.failOk?!0:!1)},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this.declaredClass+": Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error(this.declaredClass+": Invalid attribute argument.")},getValue:function(e,a,t){var r=this.getValues(e,a);return r.length>0?r[0]:t},getValues:function(e,a){return this._assertIsItem(e),this._assertIsAttribute(a),(e[a]||[]).slice(0)},getAttributes:function(e){this._assertIsItem(e);var a=[];for(var t in e)t!==this._storeRefPropName&&t!==this._itemNumPropName&&t!==this._rootItemPropName&&t!==this._reverseRefMap&&a.push(t);return a},hasAttribute:function(e,a){return this._assertIsItem(e),this._assertIsAttribute(a),a in e},containsValue:function(e,a,t){var r=void 0;return"string"==typeof t&&(r=l.patternToRegExp(t,!1)),this._containsValue(e,a,t,r)},_containsValue:function(e,t,d,i){return r.some(this.getValues(e,t),function(e){if(null!==e&&!a.isObject(e)&&i){if(e.toString().match(i))return!0}else if(d===e)return!0})},isItem:function(e){return e&&e[this._storeRefPropName]===this&&this._arrayOfAllItems[e[this._itemNumPropName]]===e?!0:!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){this._assertIsItem(e.item)},getFeatures:function(){return this._features},getLabel:function(e){return this._labelAttr&&this.isItem(e)?this.getValue(e,this._labelAttr):void 0},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},filter:function(e,a,t){var r,d,i=[];if(e.query){var o,n=e.queryOptions?e.queryOptions.ignoreCase:!1,m={};for(d in e.query)o=e.query[d],"string"==typeof o?m[d]=l.patternToRegExp(o,n):o instanceof RegExp&&(m[d]=o);for(r=0;r<a.length;++r){var s=!0,f=a[r];if(null===f)s=!1;else for(d in e.query)o=e.query[d],this._containsValue(f,d,o,m[d])||(s=!1);s&&i.push(f)}t(i,e)}else{for(r=0;r<a.length;++r){var y=a[r];null!==y&&i.push(y)}t(i,e)}},_fetchItems:function(t,r,i){var l=this;if(this._loadFinished)this.filter(t,this._getItemsArray(t.queryOptions),r);else if(this._jsonFileUrl!==this._ccUrl?(e.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:t,filter:a.hitch(l,"filter"),findCallback:a.hitch(l,r)});else{this._loadInProgress=!0;var o={url:l._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},n=d.get(o);n.addCallback(function(e){try{l._getItemsFromLoadedData(e),l._loadFinished=!0,l._loadInProgress=!1,l.filter(t,l._getItemsArray(t.queryOptions),r),l._handleQueuedFetches()}catch(a){l._loadFinished=!0,l._loadInProgress=!1,i(a,t)}}),n.addErrback(function(e){l._loadInProgress=!1,i(e,t)});var m=null;t.abort&&(m=t.abort),t.abort=function(){var e=n;e&&-1===e.fired&&(e.cancel(),e=null),m&&m.call(t)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,l.filter(t,this._getItemsArray(t.queryOptions),r)}catch(s){i(s,t)}else i(new Error(this.declaredClass+": No JSON source data was provided as either URL or a nested Javascript object."),t)},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var e=0;e<this._queuedFetches.length;e++){var a=this._queuedFetches[e],t=a.args,r=a.filter,d=a.findCallback;r?r(t,this._getItemsArray(t.queryOptions),d):this.fetchItemByIdentity(t)}this._queuedFetches=[]}},_getItemsArray:function(e){return e&&e.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&(!(""!=this._jsonFileUrl&&null!=this._jsonFileUrl||""!=this.url&&null!=this.url||null!=this.data),this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(e){function t(e){return null!==e&&"object"==typeof e&&(!a.isArray(e)||d)&&!a.isFunction(e)&&(e.constructor==Object||a.isArray(e))&&"undefined"==typeof e._reference&&"undefined"==typeof e._type&&"undefined"==typeof e._value&&i.hierarchical}function r(e){i._arrayOfAllItems.push(e);for(var d in e){var l=e[d];if(l)if(a.isArray(l))for(var o=l,n=0;n<o.length;++n){var m=o[n];t(m)&&r(m)}else t(l)&&r(l)}}var d=!1,i=this;this._labelAttr=e.label;var l,o;for(this._arrayOfAllItems=[],this._arrayOfTopLevelItems=e.items,l=0;l<this._arrayOfTopLevelItems.length;++l)o=this._arrayOfTopLevelItems[l],a.isArray(o)&&(d=!0),r(o),o[this._rootItemPropName]=!0;var n,m={};for(l=0;l<this._arrayOfAllItems.length;++l){o=this._arrayOfAllItems[l];for(n in o){if(n!==this._rootItemPropName){var s=o[n];null!==s?a.isArray(s)||(o[n]=[s]):o[n]=[null]}m[n]=n}}for(;m[this._storeRefPropName];)this._storeRefPropName+="_";for(;m[this._itemNumPropName];)this._itemNumPropName+="_";for(;m[this._reverseRefMap];)this._reverseRefMap+="_";var f,y=e.identifier;if(y)for(this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=y,l=0;l<this._arrayOfAllItems.length;++l){o=this._arrayOfAllItems[l],f=o[y];var M=f[0];if(Object.hasOwnProperty.call(this._itemsByIdentity,M)){if(this._jsonFileUrl)throw new Error(this.declaredClass+":  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+y+"].  Value collided: ["+M+"]");if(this._jsonData)throw new Error(this.declaredClass+":  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+y+"].  Value collided: ["+M+"]")}else this._itemsByIdentity[M]=o}else this._features["dojo.data.api.Identity"]=Number;for(l=0;l<this._arrayOfAllItems.length;++l)o=this._arrayOfAllItems[l],o[this._storeRefPropName]=this,o[this._itemNumPropName]=l;for(l=0;l<this._arrayOfAllItems.length;++l){o=this._arrayOfAllItems[l];for(n in o){f=o[n];for(var u=0;u<f.length;++u)if(s=f[u],null!==s&&"object"==typeof s){if("_type"in s&&"_value"in s){var v=s._type,h=this._datatypeMap[v];if(!h)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+v+"'");if(a.isFunction(h))f[u]=new h(s._value);else{if(!a.isFunction(h.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");f[u]=h.deserialize(s._value)}}if(s._reference){var c=s._reference;if(a.isObject(c))for(var F=0;F<this._arrayOfAllItems.length;++F){var p=this._arrayOfAllItems[F],g=!0;for(var w in c)p[w]!=c[w]&&(g=!1);g&&(f[u]=p)}else f[u]=this._getItemByIdentity(c);if(this.referenceIntegrity){var b=f[u];this.isItem(b)&&this._addReferenceToMap(b,o,n)}}else this.isItem(s)&&this.referenceIntegrity&&this._addReferenceToMap(s,o,n)}}}},_addReferenceToMap:function(){},getIdentity:function(e){var a=this._features["dojo.data.api.Identity"];if(a===Number)return e[this._itemNumPropName];var t=e[a];return t?t[0]:null},fetchItemByIdentity:function(a){var t,r;if(this._loadFinished)t=this._getItemByIdentity(a.identity),a.onItem&&(r=a.scope?a.scope:e.global,a.onItem.call(r,t));else{var i=this;if(this._jsonFileUrl!==this._ccUrl?(e.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&null==this._jsonData&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:a});else{this._loadInProgress=!0;var l={url:i._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},o=d.get(l);o.addCallback(function(r){var d=a.scope?a.scope:e.global;try{i._getItemsFromLoadedData(r),i._loadFinished=!0,i._loadInProgress=!1,t=i._getItemByIdentity(a.identity),a.onItem&&a.onItem.call(d,t),i._handleQueuedFetches()}catch(l){i._loadInProgress=!1,a.onError&&a.onError.call(d,l)}}),o.addErrback(function(t){if(i._loadInProgress=!1,a.onError){var r=a.scope?a.scope:e.global;a.onError.call(r,t)}})}else this._jsonData&&(i._getItemsFromLoadedData(i._jsonData),i._jsonData=null,i._loadFinished=!0,t=i._getItemByIdentity(a.identity),a.onItem&&(r=a.scope?a.scope:e.global,a.onItem.call(r,t)))}},_getItemByIdentity:function(e){var a=null;return this._itemsByIdentity?Object.hasOwnProperty.call(this._itemsByIdentity,e)&&(a=this._itemsByIdentity[e]):Object.hasOwnProperty.call(this._arrayOfAllItems,e)&&(a=this._arrayOfAllItems[e]),void 0===a&&(a=null),a},getIdentityAttributes:function(){var e=this._features["dojo.data.api.Identity"];return e===Number?null:[e]},_forceLoad:function(){var a=this;if(this._jsonFileUrl!==this._ccUrl?(e.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl){var t={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0},r=d.get(t);r.addCallback(function(e){try{if(a._loadInProgress===!0||a._loadFinished){if(a._loadInProgress)throw new Error(this.declaredClass+":  Unable to perform a synchronous load, an async load is in progress.")}else a._getItemsFromLoadedData(e),a._loadFinished=!0}catch(t){throw t}}),r.addErrback(function(e){throw e})}else this._jsonData&&(a._getItemsFromLoadedData(a._jsonData),a._jsonData=null,a._loadFinished=!0)}});return a.extend(m,o),m});//# sourceMappingURL=ItemFileReadStore.js.map