//>>built
define("dijit/tree/dndSource",["dojo/_base/array","dojo/_base/declare","dojo/dnd/common","dojo/dom-class","dojo/dom-geometry","dojo/_base/lang","dojo/mouse","dojo/on","dojo/touch","dojo/topic","dojo/dnd/Manager","./_dndSelector"],function(e,t,a,i,r,d,o,n,l,s,m,u){var f=t("dijit.tree.dndSource",u,{isSource:!0,accept:["text","treeNode"],copyOnly:!1,dragThreshold:5,betweenThreshold:0,generateText:!0,constructor:function(e,t){t||(t={}),d.mixin(this,t);var a=t.accept instanceof Array?t.accept:["text","treeNode"];if(this.accept=null,a.length){this.accept={};for(var r=0;r<a.length;++r)this.accept[a[r]]=1}this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.dropPosition="",this._lastX=0,this._lastY=0,this.sourceState="",this.isSource&&i.add(this.node,"dojoDndSource"),this.targetState="",this.accept&&i.add(this.node,"dojoDndTarget"),this.topics=[s.subscribe("/dnd/source/over",d.hitch(this,"onDndSourceOver")),s.subscribe("/dnd/start",d.hitch(this,"onDndStart")),s.subscribe("/dnd/drop",d.hitch(this,"onDndDrop")),s.subscribe("/dnd/cancel",d.hitch(this,"onDndCancel"))]},checkAcceptance:function(){return!0},copyState:function(e){return this.copyOnly||e},destroy:function(){this.inherited(arguments);for(var e;e=this.topics.pop();)e.remove();this.targetAnchor=null},_onDragMouse:function(e,t){var a=m.manager(),i=this.targetAnchor,d=this.current,o=this.dropPosition,n="Over";if(d&&this.betweenThreshold>0&&(this.targetBox&&i==d||(this.targetBox=r.position(d.rowNode,!0)),e.pageY-this.targetBox.y<=this.betweenThreshold?n="Before":e.pageY-this.targetBox.y>=this.targetBox.h-this.betweenThreshold&&(n="After")),t||d!=i||n!=o){if(i&&this._removeItemClass(i.rowNode,o),d&&this._addItemClass(d.rowNode,n),d)if(d==this.tree.rootNode&&"Over"!=n)a.canDrop(!1);else{var l=!1,s=!1;if(a.source==this){s="Over"===n;for(var u in this.selection){var f=this.selection[u];if(f.item===d.item){l=!0;break}f.getParent().id!==d.id&&(s=!1)}}a.canDrop(!l&&!s&&!this._isParentChildDrop(a.source,d.rowNode)&&this.checkItemAcceptance(d.rowNode,a.source,n.toLowerCase()))}else a.canDrop(!1);this.targetAnchor=d,this.dropPosition=n}},onMouseMove:function(t){if(!this.isDragging||"Disabled"!=this.targetState){this.inherited(arguments);var i=m.manager();if(this.isDragging)this._onDragMouse(t);else if(this.mouseDown&&this.isSource&&(Math.abs(t.pageX-this._lastX)>=this.dragThreshold||Math.abs(t.pageY-this._lastY)>=this.dragThreshold)){var r=this.getSelectedTreeNodes();if(r.length){if(r.length>1){var d,o,n=this.selection,l=0,s=[];e:for(;d=r[l++];){for(o=d.getParent();o&&o!==this.tree;o=o.getParent())if(n[o.id])continue e;s.push(d)}r=s}r=e.map(r,function(e){return e.domNode}),i.startDrag(this,r,this.copyState(a.getCopyKeyState(t))),this._onDragMouse(t,!0)}}}},onMouseDown:function(e){("touchstart"==e.type||o.isLeft(e))&&(this.mouseDown=!0,this.mouseButton=e.button,this._lastX=e.pageX,this._lastY=e.pageY),this.inherited(arguments)},onMouseUp:function(){this.mouseDown&&(this.mouseDown=!1,this.inherited(arguments))},onMouseOut:function(){this.inherited(arguments),this._unmarkTargetAnchor()},checkItemAcceptance:function(){return!0},onDndSourceOver:function(e){if(this!=e)this.mouseDown=!1,this._unmarkTargetAnchor();else if(this.isDragging){var t=m.manager();t.canDrop(!1)}},onDndStart:function(e,t,a){this.isSource&&this._changeState("Source",this==e?a?"Copied":"Moved":"");var i=this.checkAcceptance(e,t);this._changeState("Target",i?"":"Disabled"),this==e&&m.manager().overSource(this),this.isDragging=!0},itemCreator:function(t){return e.map(t,function(e){return{id:e.id,name:e.textContent||e.innerText||""}})},onDndDrop:function(t,a,i){if("Over"==this.containerState){var r=this.tree,d=r.model,o=this.targetAnchor,n=!1;this.isDragging=!1;var l,s,m;l=o&&o.item||r.item,"Before"==this.dropPosition||"After"==this.dropPosition?(l=o.getParent()&&o.getParent().item||r.item,s=o.getIndexInParent(),"After"==this.dropPosition?(s=o.getIndexInParent()+1,m=o.getNextSibling()&&o.getNextSibling().item):m=o.item):(l=o&&o.item||r.item,n=!0);var u;e.forEach(a,function(r,n){var f=t.getItem(r.id);if(-1!=e.indexOf(f.type,"treeNode"))var h=f.data,y=h.item,c=h.getParent().item;t==this?("number"==typeof s&&l==c&&h.getIndexInParent()<s&&(s-=1),d.pasteItem(y,c,l,i,s,m)):d.isItem(y)?d.pasteItem(y,c,l,i,s,m):(u||(u=this.itemCreator(a,o.rowNode,t)),d.newItem(u[n],l,s,m))},this),n&&this.tree._expandNode(o)}this.onDndCancel()},onDndCancel:function(){this._unmarkTargetAnchor(),this.isDragging=!1,this.mouseDown=!1,delete this.mouseButton,this._changeState("Source",""),this._changeState("Target","")},onOverEvent:function(){this.inherited(arguments),m.manager().overSource(this)},onOutEvent:function(){this._unmarkTargetAnchor();var e=m.manager();this.isDragging&&e.canDrop(!1),e.outSource(this),this.inherited(arguments)},_isParentChildDrop:function(e,t){if(!e.tree||e.tree!=this.tree)return!1;for(var a=e.tree.domNode,i=e.selection,r=t.parentNode;r!=a&&!i[r.id];)r=r.parentNode;return r.id&&i[r.id]},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition),this.targetAnchor=null,this.targetBox=null,this.dropPosition=null)},_markDndStatus:function(e){this._changeState("Source",e?"Copied":"Moved")}});return f});//# sourceMappingURL=dndSource.js.map